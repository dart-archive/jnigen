// JlObject => a lightweight base class for classes generated by jni_gen
// JlString => A subclass of JlObject for representing Strings,
// some special handling.
import 'dart:ffi';

import 'package:ffi/ffi.dart';

import 'third_party/jni_bindings_generated.dart';
import 'jni_exceptions.dart';
import 'jni.dart';

class JlObject {
  JlObject.fromRef(this.reference);

  /// Global reference to the object
  JObject reference;

  bool _deleted = false;

  /// delete
  void delete() {
    if (_deleted) {
      throw DoubleFreeException(this, reference);
    }
    _deleted = true;
    // TODO: this should be done in jni-thread-safe way
    // will be solved when #12 is implemented.
    Jni.getInstance().getEnv().DeleteGlobalRef(reference);
  }
}

class JlString extends JlObject {
  JlString.fromRef(JString reference) : super.fromRef(reference);

  static JString _toJavaString(String s) {
    final chars = s.toNativeUtf8().cast<Char>();
    final jstr = Jni.getInstance().toJavaString(chars);
    malloc.free(chars);
    return jstr;
  }

  JlString.fromString(String s) : super.fromRef(_toJavaString(s));

  String toDartString() {
    final jni = Jni.getInstance();
    if (reference == nullptr) {
      throw NullJlStringException();
    }
    final chars = jni.getJavaStringChars(reference);
    final result = chars.cast<Utf8>().toDartString();
    jni.releaseJavaStringChars(reference, chars);
    return result;
  }

  late final _dartString = toDartString();

  @override
  String toString() => _dartString;
}
